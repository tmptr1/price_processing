---
ИЗМЕНИТЬ ГРАДАЦИЮ В 3.1 ГРАДАЦИИ!!! СКАЗАТЬ ПОСЛЕ ТОГО КАК ДОДЕЛАЮ НОВУЮ ВЕРСИЮ ПРИЛОЖЕНИЯ
+ отключить логи в консоли
+ значение nan
- id serial + restart seq
+ запрет из исключений
- timeout при запросе
+ 03Наименование, 01Артикул двойные пробелы (замени на одинарные между словами) и у бери пробелы в начале и конце
?несохранённые файлы
+ дублирование
? индексы на другие столбцы
+ 2ССС / +1МТЗ / (+VALA, +1VAL) / +1KDA
перезапуск
проценты (10% и 20.00)
+ 12сумма
+- перенос настроек почты
процент пройденных позиций
+ колонки Бренд или в ней пустое значение, то подставлять данные отсюда
+ thread count, chunk size
долгий autovacuum
ждать окончания autovacuum?
+ НЕ СОХРАНЯТЬ прайсы по новой
+ копировать в новую таблицу в бд
+ автоудаление из total_price
+ mp.freeze_support()
+ автотаблицы 1, 2
+ индексы hash
+ XML
вэб интерфейс внутри сети?

insert into mail_report(price_code) values('1SHI'), ('1TEM'), ('1IMP'), ('1AVX') / days=1

!!!! первый раз было - Sender: ?UTF-8?B?0YHQvdC+0LTQsNGA? !!!!


/var/lib/pgsql/<версия>/data/postgresql.conf
shared_buffers = 4GB
work_mem = 128MB
maintenance_work_mem = 2GB
effective_cache_size = 12GB

work_mem = 32MB
+ maintenance_work_mem = 2GB
+ wal_level = replica
+ wal_buffers = 16MB
+ max_wal_size = 2GB
+ min_wal_size = 512MB
+ checkpoint_completion_target = 0.9
+ checkpoint_timeout = 15min
+ effective_cache_size = 12GB
+ wal_compression = on
?
+ max_parallel_workers = 8
+ max_parallel_workers_per_gather = 4
parallel_setup_cost = 1000
parallel_tuple_cost = 0.1

?UNLOGGED

ytopttorg@mail.ru

отправка прайсов только если недавно не отправлялся прайс
удалять через год заказы
дни отправки в справочнике!!!
.subquery
mult_less from calc
+ убрать доп поля
у всех продаём для ос (да) высчитать цену заранее, а в PriceSender по обратному условию (FinalPrice.delay > self.price_settings.delay)
cte с КФом по каждому прайсу поставщика
вынести сохранение прайсов, чтобы не тормозило отправку (сохранить final_price в сыром виде, дальше отдельным модулем сохранять его в историю)
Уведомление в отчёт об отключении прайса
логи БД log_truncate_on_rotation=on, log_rotation_age=5d

+ сохранять все прайсы в историю
+ удаление прайсов по сроку обновления
не создавать csv при кол-во 0
2 потока PriceSender
конфиг БД под м2
?органичение по МБ
прайсы по api
+ удаление неактуальных прайсов из истории
+ отправка 4
+ send_mail
+ DUPL
+ сортировка в ;;;
+ статус с 0 колвом, не формировать заново такие прайсы
+ указывать список прайсов которые были загружены и которые остались ; 1MIK 2300/1700;
+ итоговая таблица для прайсов
ШтР расчёт?? при обновлении 3.0
+ время в таблицах
+ новый код в брендах (оставить только уникальные)
+ отчёт с доп инфой
?добавить в конце
-доп столбец
-проверить прогу на ссд
+ конфиг
+ кратность
+ при удалении дублей всегда c_art=art
+ вернуть старое удаление дублей
+ checkbox "отправлять", progress bar
+ отправка по времени
+ доп папка
+ инфо таблица
-именно отправка до 14
(после запуска нового модуля) отнимать ШтР только при формировании прайса на отправку + проверять время обновоения 3.0 и ласт время вычета ШтР
ошибка при записи в TP2 (добавить try начиная с TP2 delete)
    - psycopg2.errors.DeadlockDetected: deadlock detected
    - sqlalchemy.exc.OperationalError: (psycopg2.errors.DeadlockDetected) deadlock detected
+ оптимизировать удаление дублей в обработке
+ пересохранение прайсов
+ удалить 0 цена
+ дни недели, до 14 00
+ пробелы в почте
+-доп столбец (кол-вом - штр) (название оставить старое), отнимать штр от обычного кол-ва при расчёте прайса + при обновлении 3.0 обнулять штр и пересчитывать кол-во - штр
? поменять кол-во воркеров
?обновление 3.0 раз в день
2 таблицы total2, одна без индексов
+ обновление данных в итоговом прайсе ночью
?прерывать обработку если пришел прайс новее
локальная БД?
+ int in df
+ папка в почте
+ сортировка по коду прайса в tg
+ убрать лишние символы в артикул, бренд (новый артикул)
+ добавить столбец В прайс
+ add log notice about 1,2 thread
+ dupl SumTable
+ отображение потоков в PriceReader
+ size лимит брать из БД, а не при объявления классов
+ MB input
+ save time
+ полное обновление итога по условиям 3.0 + ЦенаБ + ПредложенийОпт ночью  -(в модуле calculate, когда все calc и calc2 остановятся)
+ фикс время обновления ЦенаБ, ПО
+ drop price1/price2 tables, autovacuum_enable=False
+ автоперерасчёт 3.0
+ отключить авторестарт 2 (ежедневная проверка)
+ tg bot
+ =?windows-1251?B?weXr7vPxIMDt5PDl6SDN6Oru6+Dl4uj3?=	<andrey.belous@yug-avto.ru
+-забивается память в postgres
+ удаление неактуальных прайсов с папки exit_1
+ Верхний рег 01, 14
+ проверить кол-во итоговых страниц
+ динамическое кол-во страниц
+ несохранённые прайсы
+ ежедневный рестарт
справочники после второго модуля, чтобы не считать дубли?
градация не используется?
+ сравнение кол-во позиций по прайсам
?убрать Кратность_меньше, добавить проверку (исправить новую кратность (кратность > кол-во, то кол-во = кратность))
----------------
+ total count label
+ exit2 csv
+ курс валют для total2
+ удаление неактуальных прайсов2
+ Наценка_на_праздники_1_02
+ _05price_plus
+ одинаковые rc в file_settings
+ сравнение итогов
+ индексы 3.0
+ brand_s = ''
+ поменять путь до справочников в 1 проге
+ ЦенаБ и Предложений в опте 24 часа
не подходит по сроку
+ убрать проверку на 07 код
update set regex ... where like ... + gist/gin index
+ кол-во позиций без артикула в отчёте
+ подробное инфо почему не прошел прайс по строкам
+ перейти на новый лист (
+ изменение цены по условиям - Производитель поставщика, Цена поставщика
+ cols_fix,
+ слова исключения - varchar S, 20ИслючитьИзПрайса )
+ (4/19)
+ кол-во 10-100, >5 цена 15.99
+ заменить пробелы на корр. пробелы
reindex (на все индексы)
autovacuum
ускорить csv (intpk?)
+ ; заменять на ,
+ отнять штр из сопоставления
вариант наименование с заглавной буквы
убрать дублирование почты

- дублирование прайсов
+ убрать штуки - от цены
+ полная обработка дочерних прайсов
+ удаление из дочерних 20
+ 17 код "_"
+ дефолт кратность = 1
+ add def create_csv + for children
+ автоудаление (если не сохранять или при родителе не стандартизировать) (дочерние прайсы)
кнопки

перезапуск по os.getpid() + ?если долго нет сигнала (по логам! wait 120)
прога с автоперезапуском
restart.py:
 if time = 6:00:
  kill start.py
  start ...

start.py (in crlc):
while
 autostart.txt
 os ... main.py
 delay

---
?flush
?pool size
bat
? автодроп всех таблиц при обнулении БД
отчёт на почту (+автообновление отчёта)
курс валют + её время обновления
автоотчёты
?select where reason = Для прайса {file_name_} нет подходящих настроек
+ градация по чанкам
+ сохранять логи локально + дублировать в сетевую папку ([Errno 2] No such file or directory: '\\\\DESKTOP-9UVV31P\\w\\test_f.txt')
+ try get_engine
+ справочники
+ Начинается с / Содержит / Не содержит
+ обнуление таблиц в БД по кнопке
+ справочники
+ data07&14 и для res доп. столбец правильное/_14Производитель_заполнен с нижним регистром
+ mass offers & base price add low column
+ commit только в конце обновления
+ загрузка логов в консоль только при старте (+ '----')
+ папки
+ почта
+ отчёт по почте
+ кнопка для открытия logs.txt
+ исправить R11C


*****
[2025-07-24 03:48:22] get_mail Error: Traceback (most recent call last):
  File "MailParser.py", line 176, in get_mail
  File "MailParser.py", line 203, in load_content
  File "_strptime.py", line 655, in _strptime_datetime
  File "_strptime.py", line 434, in _strptime
ValueError: time data '2025-07-23 08:38:34' does not match format '%d %b %Y %H-%M-%S'
*****


add NOTICE:
delete
uuid (+ replace in to_sql)


TABLE:
создавать авторестарт.txt каждый вечер
mass offers and prive b

==== INDEXES ====
SELECT * FROM pg_indexes where schemaname = 'public'

==== PID ====
SELECT pid,
           now() - query_start AS duration,
           wait_event_type,
           wait_event,
           state,
           query
    FROM pg_stat_activity
    WHERE state != 'idle'
    ORDER BY duration DESC;

==== autovacuum_enabled ====
SELECT
    nspname AS schema_name,
    relname AS table_name,
    'autovacuum_enabled' AS parameter,
    CASE
        WHEN reloptions IS NULL THEN 'true' -- Если нет опций, включено глобально
        WHEN array_to_string(reloptions, ',') LIKE '%autovacuum_enabled%' THEN
            CASE
                WHEN (array_to_string(reloptions, ',') ~ 'autovacuum_enabled=false') THEN 'false'
                ELSE 'true'
            END
        ELSE 'true' -- Если нет в reloptions, включено глобально
    END AS is_enabled
FROM pg_catalog.pg_class c
JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace
WHERE nspname = 'public' -- Замените на имя вашей схемы
  AND relname = 'app_settings';

=====
ALTER SYSTEM SET autovacuum_naptime = '5min';       default - 1min



= Value.NativeQuery(PostgreSQL.Database("100.200.30.40", "price_processing", [CreateNavigationProperties=false]),
"select key1_s as ""Ключ1 поставщика"", article_s as ""Артикул поставщика"", brand_s as ""Производитель поставщика"",
name_s as ""Наименование поставщика"", count_s as ""Количество поставщика"", price_s as ""Цена поставщика"",
mult_s as ""Кратность поставщика"", notice_s as ""Примечание поставщика"", _01article as ""01Артикул"",
_02brand as ""02Производитель"", _03name as ""03Наименование"", _05price as ""05Цена"", _06mult as ""06Кратность-"",
_07supplier_code as ""07Код поставщика"", _09code_supl_goods as ""09Код + Поставщик + Товар"", _10original as ""10Оригинал"",
_13grad as ""13Градация"", _14brand_filled_in as ""14Производитель заполнен"", _15code_optt as ""15КодТутОптТорг"",
_17code_unique as ""17КодУникальности"", _18short_name as ""18КороткоеНаименование"", _19min_price as ""19МинЦенаПоПрайсу"",
_20exclude as ""20ИсключитьИзПрайса"", delay as ""Отсрочка"", ""sell_for_OS"" as ""Продаём для ОС"",
markup_os as ""Наценка для ОС"", ""markup_R"" as ""Наценка Р"", markup_pb as ""Наценка ПБ"", min_markup as ""Мин наценка"",
min_wholesale_markup as ""Мин опт наценка"", markup_wh_goods as ""Наценка на оптовые товары"", grad_step as ""Шаг градаци"",
wh_step as ""Шаг опт"",  access_pp as ""Разрешения ПП"", put_away_zp as ""УбратьЗП"", offers_wh as ""Предложений опт"",
price_b as ""ЦенаБ"", count as ""Кол-во"", code_pb_p as ""Код ПБ_П"", _06mult_new as ""06Кратность"",
mult_less as ""Кратность меньше"", _05price_plus as ""05Цена+"", buy_count as ""Количество закупок"",
unload_percent as ""% Отгрузки"", min_price as ""Мин. Цена"", min_supplier as ""Мин. Поставщик"" from total_price_2", null, [EnableFolding=true])

select key1_s as ""Ключ1 поставщика"", article_s as ""Артикул поставщика"", brand_s as ""Производитель поставщика"", name_s as ""Наименование поставщика"", count_s as ""Количество поставщика"", price_s as ""Цена поставщика"", mult_s as ""Кратность поставщика"", notice_s as ""Примечание поставщика"", _01article as ""01Артикул"", _02brand as ""02Производитель"", _03name as ""03Наименование"", _05price as ""05Цена"", _06mult as ""06Кратность-"", _07supplier_code as ""07Код поставщика"", _09code_supl_goods as ""09Код + Поставщик + Товар"", _10original as ""10Оригинал"", _13grad as ""13Градация"", _14brand_filled_in as ""14Производитель заполнен"", _15code_optt as ""15КодТутОптТорг"", _17code_unique as ""17КодУникальности"", _18short_name as ""18КороткоеНаименование"", _19min_price as ""19МинЦенаПоПрайсу"", _20exclude as ""20ИсключитьИзПрайса"", delay as ""Отсрочка"", ""sell_for_OS"" as ""Продаём для ОС"", markup_os as ""Наценка для ОС"", ""markup_R"" as ""Наценка Р"", markup_pb as ""Наценка ПБ"", min_markup as ""Мин наценка"", min_wholesale_markup as ""Мин опт наценка"", markup_wh_goods as ""Наценка на оптовые товары"", grad_step as ""Шаг градаци"", wh_step as ""Шаг опт"",  access_pp as ""Разрешения ПП"", put_away_zp as ""УбратьЗП"", offers_wh as ""Предложений опт"", price_b as ""ЦенаБ"", count as ""Кол-во"", code_pb_p as ""Код ПБ_П"", _06mult_new as ""06Кратность"", mult_less as ""Кратность меньше"", _05price_plus as ""05Цена+"", buy_count as ""Количество закупок"", unload_percent as ""% Отгрузки"", min_price as ""Мин. Цена"", min_supplier as ""Мин. Поставщик"" from total_price_2


================

UPDATE price_2 SET _20exclude='D2' FROM (SELECT price_2._01article_comp AS _01article_comp,
price_2._14brand_filled_in AS _14brand_filled_in FROM price_2
GROUP BY price_2._01article_comp, price_2._14brand_filled_in
HAVING count(price_2.id) > 1) AS anon_1,
(SELECT price_2._01article_comp AS _01article_comp, price_2._14brand_filled_in AS _14brand_filled_in,
max(price_2._04count) AS max_c FROM price_2
WHERE price_2._20exclude = 'D1' GROUP BY price_2._01article_comp, price_2._14brand_filled_in) AS anon_2
WHERE price_2._01article_comp = anon_1._01article_comp AND price_2._14brand_filled_in = anon_1._14brand_filled_in
AND price_2._04count = anon_2.max_c RETURNING price_2.id

UPDATE price_2_2 SET _20exclude='D1' FROM (SELECT price_2_2._01article_comp AS _01article_comp,
price_2_2._14brand_filled_in AS _14brand_filled_in FROM price_2_2 GROUP BY price_2_2._01article_comp, price_2_2._14brand_filled_in
HAVING count(price_2_2.id) > 1) AS anon_1, (SELECT price_2_2._01article_comp AS _01article_comp,
price_2_2._14brand_filled_in AS _14brand_filled_in, min(price_2_2._05price) AS min_p
FROM price_2_2 WHERE price_2_2._20exclude = 'D' GROUP BY price_2_2._01article_comp, price_2_2._14brand_filled_in)
AS anon_2 WHERE price_2_2._01article_comp = anon_1._01article_comp AND price_2_2._14brand_filled_in =
anon_1._14brand_filled_in AND price_2_2._05price = anon_2.min_p RETURNING price_2_2.id


UPDATE price_2_2 SET _20exclude='D1' FROM (SELECT price_2_2._01article_comp AS _01article_comp, price_2_2._14brand_filled_in AS _14brand_filled_in
FROM price_2_2 GROUP BY price_2_2._01article_comp, price_2_2._14brand_filled_in
HAVING count(price_2_2.id) > 1) AS anon_1, (SELECT price_2_2._01article_comp AS _01article_comp, price_2_2._14brand_filled_in AS _14brand_filled_in, min(price_2_2._05price) AS min_p
FROM price_2_2
WHERE price_2_2._20exclude = 'D' GROUP BY price_2_2._01article_comp, price_2_2._14brand_filled_in) AS anon_2 WHERE price_2_2._01article_comp = anon_1._01article_comp AND price_2_2._14brand_filled_in = anon_1._14brand_filled_in AND price_2_2._05price = anon_2.min_p RETURNING price_2_2.id


===============


Код прайса покупателя: price_code
Ключ1 поставщика: key1_s
Артикул поставщика: article_s
Производитель поставщика: brand_s
Наименование поставщика: name_s
Количество поставщика: count_s
Цена поставщика: price_s
Валюта поставщика: currency_s
Кратность поставщика: mult_s
Примечание поставщика: notice_s
Чистый 01Артикул: _01article_comp
02Производитель: _02brand
03Наименование: _03name_old
04Количество: _04count
05Цена: _05price
05Цена плюс: _05price_plus
07Код_поставщика: _07supplier_code
14Производитель заполнен: _14brand_filled_in
15КодТутОптТорг: _15code_optt
Старое кол-во: count_old
----------
Артикул: _01article
Бренд: brand
Наименование: _03name
Кол-во: count
Цена: price
Кратность: _06mult_new
17КодУникальности: _17code_unique
----------
Время обновления прайса поставщика: supplier_update_time
Время отправки прайса покупателю: send_time

---------------
Заказ: order_time
Клиент: client
Автомат: auto
В ручную: manually
Для сортировки: for_sort
Ключ1 в заказ: key_1_ord
Артикул в заказ: article_ord
Производитель в заказ: brand_ord
Заказ шт: count_ord
Цена в заказ: price_ord
В 1С Код наш: code_1c
В 1С Артикул наш: article_1c
Тех. Артикул: article
Тех.Производитель: brand
Тех. Кол-во: count
Тех. Цена: price
Тех. Наименование: name
Код ТутОптТорг: code_optt
Наш производитель: our_brand
09Код: code_09
Предложений опт: offers_wh
Отказано шт: refuse
Заявка сумма: ord_sum
Сумма в закупке: buy_sum
ВП по подтверждённому: vp_accept
Сумма подтверждённого: sum_accept
Тип товара: product_typ

Время загрузки: updated_at